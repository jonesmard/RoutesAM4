<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexGen HUB - Gestão Profissional AM4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
        .glass-effect { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(16px); }
        .dark .glass-effect { background: rgba(15, 23, 42, 0.9); }
        .btn-active:active { transform: scale(0.95); }
        #global-overlay { z-index: 9999; }
        .modal-overlay { background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 min-h-screen pb-20">

    <div id="app">
        <!-- Overlay Global (Login e Sincronização) -->
        <div id="global-overlay" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-950 transition-all duration-700">
            <div class="max-w-sm w-full px-8 text-center">
                <div id="status-ui">
                    <div id="auth-loader" class="inline-block animate-spin text-blue-600 mb-8">
                        <i data-lucide="loader-2" class="w-12 h-12"></i>
                    </div>
                    <p id="loading-text" class="text-slate-500 text-[10px] font-black uppercase tracking-[0.2em]">Sincronizando Malha Aérea...</p>
                </div>
                
                <div id="login-container" class="hidden animate-in fade-in zoom-in duration-500">
                    <div class="bg-gradient-to-br from-blue-600 to-indigo-700 w-20 h-20 rounded-[2rem] flex items-center justify-center mx-auto mb-8 shadow-2xl">
                        <i data-lucide="plane-takeoff" class="text-white w-10 h-10"></i>
                    </div>
                    <h2 class="text-2xl font-black text-white uppercase tracking-tighter mb-2">NexGen HUB</h2>
                    <p class="text-slate-400 text-[10px] font-bold mb-10 uppercase tracking-[0.3em]">Operações de Voo</p>
                    
                    <button id="google-login-btn" class="w-full flex items-center justify-center gap-4 bg-white text-slate-900 py-4 rounded-2xl font-black text-xs uppercase tracking-widest hover:bg-slate-100 transition-all shadow-xl border-b-4 border-slate-200 btn-active">
                        <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 6.23l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                        Entrar com Google
                    </button>
                </div>

                <div id="upload-ui" class="hidden">
                    <p class="text-white font-black uppercase text-xs tracking-widest animate-pulse mb-4">Gravando Dados no Satélite...</p>
                    <div class="w-full bg-slate-800 h-1.5 rounded-full overflow-hidden">
                        <div id="upload-bar" class="bg-blue-600 h-full w-0 transition-all duration-500"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal: HUB de Origem -->
        <div id="hub-modal" class="hidden fixed inset-0 z-[110] modal-overlay flex items-center justify-center p-6">
            <div class="bg-white dark:bg-slate-900 w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl animate-in zoom-in duration-300">
                <div class="bg-blue-600 w-16 h-16 rounded-2xl flex items-center justify-center mb-6 shadow-xl">
                    <i data-lucide="map-pin" class="text-white w-8 h-8"></i>
                </div>
                <h3 class="text-xl font-black uppercase tracking-tighter mb-2">Hub de Origem</h3>
                <p class="text-slate-500 text-xs font-medium mb-6">Identifique o aeroporto de origem para este lote de rotas.</p>
                <input type="text" id="hub-iata-input" placeholder="EX: JFK" maxlength="3" 
                       class="w-full p-4 rounded-2xl bg-slate-100 dark:bg-slate-800 border-none font-black text-center text-3xl uppercase tracking-widest outline-none focus:ring-4 focus:ring-blue-500/20 mb-6">
                <button id="confirm-hub-btn" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black text-xs uppercase tracking-widest hover:bg-blue-700 transition-all btn-active shadow-lg shadow-blue-500/20">Salvar Malha Aérea</button>
            </div>
        </div>

        <!-- Modal: Gestão de Ficheiros -->
        <div id="manage-modal" class="hidden fixed inset-0 z-[110] modal-overlay flex items-center justify-center p-4">
            <div class="bg-white dark:bg-slate-900 w-full max-w-md rounded-[2.5rem] flex flex-col max-h-[85vh] shadow-2xl animate-in slide-in-from-bottom-4 duration-300 overflow-hidden">
                <div class="p-8 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-white dark:bg-slate-900 sticky top-0 z-10">
                    <div>
                        <h3 class="text-xl font-black uppercase tracking-tighter">Gestão de Dados</h3>
                        <p class="text-slate-500 text-[10px] font-bold uppercase tracking-widest mt-1">Histórico de Importações</p>
                    </div>
                    <button onclick="toggleManageModal()" class="p-2 bg-slate-100 dark:bg-slate-800 rounded-full hover:bg-slate-200 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div id="uploads-list" class="p-6 overflow-y-auto custom-scrollbar space-y-4 flex-1">
                    <!-- Lista de ficheiros carregada via JS -->
                </div>
                <div class="p-6 bg-slate-50 dark:bg-slate-800/50 border-t border-slate-100 dark:border-slate-800">
                    <button onclick="document.getElementById('csv-upload').click(); toggleManageModal();" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black text-xs uppercase tracking-widest flex items-center justify-center gap-3 shadow-lg shadow-blue-500/10">
                        <i data-lucide="plus" class="w-4 h-4"></i> Novo Upload
                    </button>
                </div>
            </div>
        </div>

        <!-- Header Principal -->
        <header class="sticky top-0 z-50 glass-effect border-b border-slate-200 dark:border-slate-800 px-4 py-3">
            <div class="max-w-7xl mx-auto flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 p-2 rounded-xl shadow-lg"><i data-lucide="plane" class="text-white w-5 h-5"></i></div>
                    <div>
                        <h1 class="text-sm font-black uppercase tracking-tighter leading-none">NEXGEN <span class="text-blue-600">HUB</span></h1>
                        <p class="text-[8px] font-bold text-slate-400 uppercase tracking-widest mt-1">Console v1.0</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <!-- Botão de Gestão de Arquivos Principal -->
                    <button onclick="toggleManageModal()" class="flex items-center gap-2 bg-blue-50 dark:bg-blue-900/20 text-blue-600 px-3 py-2.5 rounded-xl btn-active border border-blue-100 dark:border-blue-900/30 shadow-sm">
                        <i data-lucide="database" class="w-4 h-4"></i>
                        <span class="text-[10px] font-black uppercase hidden sm:inline">Meus Dados</span>
                    </button>

                    <div class="h-6 w-px bg-slate-200 dark:bg-slate-800 mx-1"></div>
                    
                    <button onclick="toggleUserMenu()" class="flex items-center gap-2 bg-slate-100 dark:bg-slate-800 p-1 pr-3 rounded-full border border-slate-200 dark:border-slate-700 hover:bg-slate-200 transition-all shadow-inner">
                        <img id="user-photo" src="" class="w-7 h-7 rounded-full bg-slate-300" onerror="this.src='https://ui-avatars.com/api/?name=Pilot&background=3b82f6&color=fff'">
                        <i data-lucide="chevron-down" class="w-3 h-3 text-slate-400"></i>
                    </button>
                </div>
            </div>

            <!-- Menu User -->
            <div id="user-menu" class="hidden absolute right-4 top-16 w-56 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-3 shadow-2xl p-2 animate-in slide-in-from-top-2 z-[105]">
                <p id="user-display-name" class="p-3 text-[10px] font-black uppercase border-b border-slate-100 dark:border-slate-800 mb-1"></p>
                <button onclick="logout()" class="w-full flex items-center gap-3 p-3 text-red-500 hover:bg-red-50 dark:hover:bg-red-500/10 rounded-2xl transition-all font-bold text-xs uppercase tracking-widest">
                    <i data-lucide="log-out" class="w-4 h-4"></i> Encerrar Sessão
                </button>
            </div>
        </header>

        <input type="file" id="csv-upload" accept=".csv" class="hidden" onchange="window.processCSV(event)">

        <main class="max-w-7xl mx-auto px-4 py-6">
            <!-- Estatísticas -->
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-8">
                <div class="bg-white dark:bg-slate-900 p-5 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-sm">
                    <p class="text-[9px] uppercase font-black text-slate-400 mb-1">Rotas Salvas</p>
                    <p id="stat-count" class="text-2xl font-black">0</p>
                </div>
                <div class="bg-white dark:bg-slate-900 p-5 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-sm">
                    <p class="text-[9px] uppercase font-black text-slate-400 mb-1">Operacionais</p>
                    <p id="stat-active" class="text-2xl font-black text-emerald-500">0</p>
                </div>
                <div class="col-span-2 sm:col-span-1 bg-gradient-to-br from-blue-600 to-blue-700 p-5 rounded-3xl shadow-xl shadow-blue-500/20">
                    <p class="text-[9px] uppercase font-black text-blue-100 mb-1">Lucro Estimado</p>
                    <p id="stat-profit" class="text-2xl font-black text-white">$0</p>
                </div>
            </div>

            <!-- Painel de Filtros -->
            <div class="bg-white dark:bg-slate-900 p-5 rounded-[2rem] border border-slate-200 dark:border-slate-800 mb-10 space-y-4 shadow-sm">
                <div class="relative">
                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"></i>
                    <input type="text" id="search-input" placeholder="Pesquisar Destino ou IATA..." 
                           class="w-full pl-11 pr-4 py-4 rounded-2xl bg-slate-50 dark:bg-slate-800 border-none font-bold text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                </div>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                    <select id="filter-type" class="bg-slate-50 dark:bg-slate-800 p-3 rounded-xl text-[10px] font-black uppercase outline-none cursor-pointer">
                        <option value="all">Todos Tipos</option>
                        <option value="passenger">Passageiros</option>
                        <option value="cargo">Carga</option>
                    </select>
                    <select id="filter-aircraft" class="bg-slate-50 dark:bg-slate-800 p-3 rounded-xl text-[10px] font-black uppercase outline-none cursor-pointer"></select>
                    <select id="filter-origin" class="bg-slate-50 dark:bg-slate-800 p-3 rounded-xl text-[10px] font-black uppercase outline-none cursor-pointer"></select>
                    <select id="filter-status" class="bg-slate-50 dark:bg-slate-800 p-3 rounded-xl text-[10px] font-black uppercase outline-none cursor-pointer">
                        <option value="all">Todos Status</option>
                        <option value="used">Ativas</option>
                        <option value="unused">Disponíveis</option>
                    </select>
                    <select id="page-limit" class="bg-slate-50 dark:bg-slate-800 p-3 rounded-xl text-[10px] font-black uppercase outline-none cursor-pointer col-span-2 md:col-span-1">
                        <option value="100">100 por pág.</option>
                        <option value="50">50 por pág.</option>
                        <option value="0">Ver Todas</option>
                    </select>
                </div>
            </div>

            <!-- Grelha de Rotas -->
            <div id="routes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-in fade-in duration-500"></div>

            <!-- Empty State -->
            <div id="empty-state" class="hidden flex flex-col items-center justify-center py-40 text-center opacity-50">
                <div class="bg-slate-200 dark:bg-slate-800 w-20 h-20 rounded-full flex items-center justify-center mb-6">
                    <i data-lucide="cloud-off" class="w-10 h-10"></i>
                </div>
                <h3 class="font-black uppercase text-sm tracking-widest text-slate-400">Sem Malha Aérea</h3>
                <p class="text-[10px] mt-2 max-w-[220px]">Adicione um ficheiro CSV e defina o seu HUB de origem para começar.</p>
                <button onclick="document.getElementById('csv-upload').click()" class="mt-8 bg-blue-600 text-white px-8 py-3 rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-blue-700 transition-all btn-active shadow-lg shadow-blue-500/20">Carregar CSV</button>
            </div>

            <!-- Paginação -->
            <div id="pagination-box" class="hidden flex items-center justify-between mt-12 p-6 bg-white dark:bg-slate-900 rounded-[2rem] border border-slate-200 dark:border-slate-800 shadow-sm">
                <button id="prev-btn" class="p-3 disabled:opacity-20 transition-all bg-slate-50 dark:bg-slate-800 rounded-xl"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                <p id="page-text" class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Página 1 / 1</p>
                <button id="next-btn" class="p-3 disabled:opacity-20 transition-all bg-slate-50 dark:bg-slate-800 rounded-xl"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
            </div>
        </main>
    </div>

    <!-- Firebase SDK Stability 11.1.0 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const config = {
            apiKey: "AIzaSyBA9SPhouEHpLCbelK5sMOIGCTI8qsdWuQ",
            authDomain: "nextgen-hub-399b2.firebaseapp.com",
            projectId: "nextgen-hub-399b2",
            storageBucket: "nextgen-hub-399b2.firebasestorage.app",
            messagingSenderId: "896098677149",
            appId: "1:896098677149:web:89a2eaacfde7efcecb7f74",
            measurementId: "G-Z6HP2BYZ44"
        };

        const appId = "nexgen_hub_v11_hybrid";
        let app, auth, db, provider;
        let state = { 
            user: null, 
            uploads: [], 
            routes: [], 
            status: {}, 
            filters: { s: "", a: "all", h: "all", st: "all", t: "all", p: 1, l: 100 } 
        };

        let tempUpload = { fileName: "", list: [], type: "passenger" };

        try {
            app = initializeApp(config);
            auth = getAuth(app);
            db = getFirestore(app);
            provider = new GoogleAuthProvider();
        } catch (e) { console.error(e); }

        window.logout = () => signOut(auth).then(() => location.reload());
        window.toggleUserMenu = () => document.getElementById('user-menu').classList.toggle('hidden');
        window.toggleManageModal = () => document.getElementById('manage-modal').classList.toggle('hidden');

        document.getElementById('google-login-btn').onclick = async () => {
            try { await signInWithPopup(auth, provider); } catch (err) { alert(err.message); }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                state.user = user;
                document.getElementById('global-overlay').classList.add('opacity-0', 'pointer-events-none');
                document.getElementById('user-photo').src = user.photoURL || '';
                document.getElementById('user-display-name').innerText = user.displayName;
                sync(user.uid);
            } else {
                document.getElementById('status-ui').classList.add('hidden');
                document.getElementById('login-container').classList.remove('hidden');
            }
        });

        function sync(uid) {
            onSnapshot(collection(db, 'artifacts', appId, 'users', uid, 'uploads'), (snap) => {
                state.uploads = snap.docs.map(d => ({ docId: d.id, ...d.data() }));
                state.routes = state.uploads.reduce((acc, curr) => acc.concat(curr.list || []), []);
                updateOpts();
                render();
                renderUploadsList();
            });
            onSnapshot(doc(db, 'artifacts', appId, 'users', uid, 'status', 'active'), (snap) => {
                state.status = snap.exists() ? (snap.data().active || {}) : {};
                render();
            });
        }

        window.processCSV = async (e) => {
            const file = e.target.files[0];
            if (!file || !state.user) return;

            const reader = new FileReader();
            reader.onload = async (ev) => {
                try {
                    const lines = ev.target.result.split(/\r?\n/).filter(l => l.trim());
                    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                    
                    const isCargo = headers.includes('cfg.l') || headers.includes('dem.l');
                    const fileType = isCargo ? "cargo" : "passenger";

                    const list = lines.slice(1).map((line, idx) => {
                        const vals = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); 
                        const o = {}; 
                        headers.forEach((h, i) => {
                            let val = vals[i] ? vals[i].replace(/"/g, '').trim() : "";
                            o[h] = val;
                        }); 
                        
                        return {
                            id: o['dest.id'] || `R-${idx}-${Date.now()}`,
                            name: o['dest.name'] || 'Aeroporto',
                            iata: o['dest.iata'] || '???',
                            country: o['dest.country'] || '-',
                            dist: parseFloat(o['direct_dist']) || parseFloat(o['full_dist']) || 0,
                            time: parseFloat(o['time']) || 0,
                            profit: parseFloat(o['profit_pt']) || 0,
                            aircraft: file.name.toLowerCase().includes('mc214') ? 'MC-21-400' : (file.name.toLowerCase().includes('b748') ? 'B747-8F' : 'Aeronave'),
                            type: fileType,
                            config: isCargo ? { l: o['cfg.l'] || "0", h: o['cfg.h'] || "0" } : { y: o['cfg.y'] || "0", j: o['cfg.j'] || "0", f: o['cfg.f'] || "0" },
                            prices: isCargo ? { l: o['tkt.l'] || "0", h: o['tkt.h'] || "0" } : { y: o['tkt.y'] || "0", j: o['tkt.j'] || "0", f: o['tkt.f'] || "0" },
                            stopover: o['stop.iata'] ? { name: o['stop.name'] || "Escala", iata: o['stop.iata'] } : null
                        };
                    });

                    tempUpload = { fileName: file.name, list, type: fileType };
                    document.getElementById('hub-modal').classList.remove('hidden');
                    document.getElementById('hub-iata-input').focus();
                } catch (err) { alert("Erro de Processamento."); }
            };
            reader.readAsText(file);
        };

        document.getElementById('confirm-hub-btn').onclick = async () => {
            const hubIata = document.getElementById('hub-iata-input').value.toUpperCase().trim();
            if (hubIata.length < 3) return alert("IATA inválido.");

            document.getElementById('hub-modal').classList.add('hidden');
            document.getElementById('global-overlay').classList.remove('opacity-0', 'pointer-events-none');
            document.getElementById('upload-ui').classList.remove('hidden');
            
            const bar = document.getElementById('upload-bar');
            bar.style.width = '60%';

            try {
                const finalRoutes = tempUpload.list.map(r => ({ ...r, origin: hubIata }));
                const docId = `up_${Date.now()}`;
                await setDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'uploads', docId), {
                    fileName: tempUpload.fileName, hub: hubIata, date: new Date().toISOString(), list: finalRoutes, type: tempUpload.type
                });
                bar.style.width = '100%';
                setTimeout(() => {
                    document.getElementById('global-overlay').classList.add('opacity-0', 'pointer-events-none');
                    document.getElementById('upload-ui').classList.add('hidden');
                    document.getElementById('hub-iata-input').value = "";
                }, 800);
            } catch (err) { alert("Falha na gravação."); }
        };

        window.deleteUpload = async (docId) => {
            if(!confirm("Remover este lote de rotas permanentemente?")) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'uploads', docId));
        };

        function renderUploadsList() {
            const container = document.getElementById('uploads-list');
            container.innerHTML = state.uploads.length === 0 ? '<p class="text-center text-slate-400 py-10 text-[10px] font-black uppercase tracking-widest">Nenhum histórico</p>' : '';
            state.uploads.forEach(up => {
                const div = document.createElement('div');
                div.className = "p-4 bg-slate-50 dark:bg-slate-800/50 rounded-2xl border border-slate-100 dark:border-slate-800 flex justify-between items-center animate-in fade-in";
                div.innerHTML = `
                    <div class="min-w-0 flex-1 pr-4">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="bg-blue-600 text-white text-[8px] font-black px-1.5 py-0.5 rounded uppercase leading-none">${up.hub}</span>
                            <span class="text-[8px] font-black uppercase ${up.type === 'cargo' ? 'text-amber-500' : 'text-emerald-500'} tracking-tighter">[${up.type}]</span>
                            <p class="text-xs font-black truncate text-slate-900 dark:text-white">${up.fileName}</p>
                        </div>
                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">${up.list.length} Rotas • ${new Date(up.date).toLocaleDateString()}</p>
                    </div>
                    <button onclick="deleteUpload('${up.docId}')" class="p-3 bg-red-500/10 text-red-500 rounded-xl hover:bg-red-500 hover:text-white transition-all">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                `;
                container.appendChild(div);
            });
            lucide.createIcons();
        }

        const fmtVal = (val, dec = 2) => {
            const n = parseFloat(String(val).replace(',', '.'));
            return isNaN(n) ? "0.00" : n.toFixed(dec);
        };

        function render() {
            const grid = document.getElementById('routes-grid');
            const filtered = state.routes.filter(r => {
                const s = r.name.toLowerCase().includes(state.filters.s.toLowerCase()) || r.iata.toLowerCase().includes(state.filters.s.toLowerCase());
                const u = state.filters.st === 'all' || (state.filters.st === 'used' ? state.status[r.id] : !state.status[r.id]);
                const a = state.filters.a === 'all' || r.aircraft === state.filters.a;
                const h = state.filters.h === 'all' || r.origin === state.filters.h;
                const t = state.filters.t === 'all' || r.type === state.filters.t;
                return s && u && a && h && t;
            });
            filtered.sort((a,b) => b.profit - a.profit);
            const paginated = state.filters.l === 0 ? filtered : filtered.slice((state.filters.p - 1) * state.filters.l, state.filters.p * state.filters.l);

            grid.innerHTML = '';
            if(state.routes.length === 0) document.getElementById('empty-state').classList.remove('hidden');
            else {
                document.getElementById('empty-state').classList.add('hidden');
                paginated.forEach(r => {
                    const isUsed = state.status[r.id];
                    const isCargo = r.type === 'cargo';
                    const card = document.createElement('div');
                    card.className = `p-6 rounded-[2.5rem] border-2 transition-all duration-300 ${isUsed ? 'bg-emerald-500/5 border-emerald-500 ring-4 ring-emerald-500/5 shadow-xl' : 'bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-800 shadow-sm'}`;
                    
                    const classesHtml = isCargo ? `
                        <div class="flex justify-between font-bold border-b border-blue-200/20 pb-1.5">
                            <span class="opacity-70 italic text-amber-500">Carga Grande</span>
                            <span class="font-black text-slate-800 dark:text-slate-100">${fmtVal(r.config.l)}% @ $${fmtVal(r.prices.l, 0)}</span>
                        </div>
                        <div class="flex justify-between font-bold">
                            <span class="opacity-70 italic text-amber-600">Carga Pesada</span>
                            <span class="font-black text-slate-800 dark:text-slate-100">${fmtVal(r.config.h)}% @ $${fmtVal(r.prices.h, 0)}</span>
                        </div>
                    ` : `
                        <div class="flex justify-between font-bold border-b border-blue-200/20 pb-1.5"><span class="opacity-70 italic text-blue-500">Classe Y</span><span class="font-black">${r.config.y} pax @ $${fmtVal(r.prices.y, 0)}</span></div>
                        <div class="flex justify-between font-bold border-b border-blue-200/20 pb-1.5"><span class="opacity-70 italic text-indigo-500">Classe J</span><span class="font-black">${r.config.j} pax @ $${fmtVal(r.prices.j, 0)}</span></div>
                        <div class="flex justify-between font-bold"><span class="opacity-70 italic text-purple-500">Classe F</span><span class="font-black">${r.config.f} pax @ $${fmtVal(r.prices.f, 0)}</span></div>
                    `;

                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center gap-1.5 font-black text-[8px]">
                                <span class="bg-blue-600 text-white px-2 py-0.5 rounded uppercase leading-none pb-1 pt-1">${r.origin}</span>
                                <i data-lucide="arrow-right" class="w-3 h-3 opacity-30"></i>
                                <span class="bg-emerald-600 text-white px-2 py-0.5 rounded uppercase leading-none pb-1 pt-1">${r.iata}</span>
                                ${isCargo ? '<span class="bg-amber-500 text-white px-2 py-0.5 rounded uppercase leading-none pb-1 pt-1">CARGO</span>' : ''}
                            </div>
                            ${isUsed ? '<span class="text-[8px] font-black text-emerald-600 uppercase bg-emerald-100 dark:bg-emerald-900/30 px-3 py-1 rounded-full animate-pulse shadow-sm">Operando</span>' : ''}
                        </div>
                        <h3 class="font-black text-lg truncate mb-1 leading-tight text-slate-800 dark:text-white">${r.name}</h3>
                        <p class="text-[10px] text-slate-400 font-bold uppercase mb-5">${r.country} • ${r.aircraft}</p>
                        <div class="grid grid-cols-3 gap-2 mb-6 text-center">
                            <div class="bg-slate-50 dark:bg-slate-800 p-2.5 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm">
                                <span class="text-[11px] font-black block">${Math.round(r.dist)}km</span>
                                <span class="text-[7px] text-slate-400 uppercase font-black tracking-tighter">Dist</span>
                            </div>
                            <div class="bg-slate-50 dark:bg-slate-800 p-2.5 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm">
                                <span class="text-[11px] font-black text-emerald-600 block">$${Math.round(r.profit/1000)}k</span>
                                <span class="text-[7px] text-slate-400 uppercase font-black tracking-tighter">Lucro</span>
                            </div>
                            <div class="bg-slate-50 dark:bg-slate-800 p-2.5 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm">
                                <span class="text-[11px] font-black block">${Math.floor(r.time)}h</span>
                                <span class="text-[7px] text-slate-400 uppercase font-black tracking-tighter">Voo</span>
                            </div>
                        </div>
                        <div class="bg-blue-600/5 dark:bg-blue-600/10 p-4 rounded-[1.8rem] border border-blue-600/10 mb-6 text-[10px] space-y-1.5 shadow-inner">
                            ${classesHtml}
                        </div>
                        <button class="use-btn w-full py-4 rounded-[1.2rem] text-[10px] font-black uppercase tracking-[0.2em] transition-all btn-active ${isUsed ? 'bg-slate-900 text-white shadow-xl' : 'bg-white text-emerald-600 border-2 border-emerald-600 hover:bg-emerald-600 hover:text-white'} shadow-sm">
                            ${isUsed ? 'Liberar Aeronave' : 'Iniciar Rota'}
                        </button>
                    `;
                    card.querySelector('.use-btn').onclick = async () => {
                        const active = { ...state.status, [r.id]: !state.status[r.id] };
                        await setDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'status', 'active'), { active });
                    };
                    grid.appendChild(card);
                });
                renderPagination(filtered.length);
            }
            document.getElementById('stat-count').innerText = state.routes.length;
            document.getElementById('stat-active').innerText = Object.values(state.status).filter(v=>v).length;
            const totalP = filtered.reduce((acc, curr) => acc + (state.status[curr.id] ? curr.profit : 0), 0);
            document.getElementById('stat-profit').innerText = `$${totalP.toLocaleString('pt-PT', {maximumFractionDigits:0})}`;
            lucide.createIcons();
        }

        function renderPagination(total) {
            const totalP = Math.ceil(total / state.filters.l) || 1;
            if (state.filters.p > totalP) state.filters.p = totalP;
            if (state.filters.l > 0 && totalP > 1) {
                document.getElementById('pagination-box').classList.remove('hidden');
                document.getElementById('page-text').innerText = `Pág ${state.filters.p} / ${totalP}`;
                document.getElementById('prev-btn').disabled = state.filters.p === 1;
                document.getElementById('next-btn').disabled = state.filters.p === totalP;
            } else document.getElementById('pagination-box').classList.add('hidden');
        }

        function updateOpts() {
            const a = document.getElementById('filter-aircraft');
            const h = document.getElementById('filter-origin');
            const airs = ['all', ...new Set(state.routes.map(r => r.aircraft))];
            const hubs = ['all', ...new Set(state.routes.map(r => r.origin))];
            a.innerHTML = airs.map(x => `<option value="${x}">${x==='all'?'Aeronave':x}</option>`).join('');
            h.innerHTML = hubs.map(x => `<option value="${x}">${x==='all'?'HUB':x}</option>`).join('');
        }

        document.getElementById('search-input').oninput = (e) => { state.filters.s = e.target.value; state.filters.p=1; render(); };
        document.getElementById('filter-type').onchange = (e) => { state.filters.t = e.target.value; state.filters.p=1; render(); };
        document.getElementById('filter-aircraft').onchange = (e) => { state.filters.a = e.target.value; state.filters.p=1; render(); };
        document.getElementById('filter-origin').onchange = (e) => { state.filters.h = e.target.value; state.filters.p=1; render(); };
        document.getElementById('filter-status').onchange = (e) => { state.filters.st = e.target.value; state.filters.p=1; render(); };
        document.getElementById('page-limit').onchange = (e) => { state.filters.l = parseInt(e.target.value); state.filters.p=1; render(); };
        document.getElementById('prev-btn').onclick = () => { state.filters.p--; render(); window.scrollTo(0,0); };
        document.getElementById('next-btn').onclick = () => { state.filters.p++; render(); window.scrollTo(0,0); };

        lucide.createIcons();
    </script>
</body>
</html>
