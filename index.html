<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexGen HUB - Gestão de Rotas</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 min-h-screen pb-10">

    <div id="app">
        <!-- Loader Inicial -->
        <div id="loading-screen" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-950">
            <div class="text-center">
                <div class="inline-block animate-spin text-blue-600 mb-4">
                    <i data-lucide="loader-2" class="w-12 h-12"></i>
                </div>
                <p class="font-black text-slate-400 uppercase tracking-widest text-sm">A Carregar HUB...</p>
            </div>
        </div>

        <!-- Header -->
        <header class="sticky top-0 z-50 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 p-4">
            <div class="max-w-7xl mx-auto flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 p-2 rounded-xl shadow-lg">
                        <i data-lucide="map" class="text-white w-5 h-5"></i>
                    </div>
                    <h1 class="text-lg font-black uppercase tracking-tighter">NEXGEN <span class="text-blue-600">HUB</span></h1>
                </div>
                
                <div class="flex items-center gap-2">
                    <button onclick="document.getElementById('csv-upload').click()" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i data-lucide="upload" class="w-5 h-5"></i>
                    </button>
                    <input type="file" id="csv-upload" accept=".csv" class="hidden">
                    <button onclick="toggleMobileMenu()" class="lg:hidden p-2 rounded-lg bg-slate-100 dark:bg-slate-800">
                        <i data-lucide="menu" id="menu-icon" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 pt-6">
            <!-- Estatísticas -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-6">
                <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                    <p class="text-[10px] uppercase font-black text-slate-400 mb-1">Total de Rotas</p>
                    <p id="stat-total" class="text-xl font-black">0</p>
                </div>
                <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                    <p class="text-[10px] uppercase font-black text-slate-400 mb-1">Rotas Ativas</p>
                    <p id="stat-active" class="text-xl font-black text-emerald-600">0</p>
                </div>
                <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                    <p class="text-[10px] uppercase font-black text-slate-400 mb-1">Lucro Estimado</p>
                    <p id="stat-profit" class="text-xl font-black text-blue-600">$0</p>
                </div>
            </div>

            <!-- Filtros -->
            <div id="filter-container" class="hidden lg:block mb-8 space-y-4">
                <div class="relative">
                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
                    <input type="text" id="search-input" placeholder="Procurar destino ou IATA..." 
                           class="w-full pl-12 pr-4 py-3 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-800 outline-none font-bold text-sm focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="grid grid-cols-2 lg:grid-cols-5 gap-3">
                    <div class="flex flex-col">
                        <label class="text-[9px] font-black uppercase text-slate-400 ml-1 mb-1">Aeronave</label>
                        <select id="filter-aircraft" class="w-full px-3 py-2 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-800 text-[11px] font-bold outline-none"></select>
                    </div>
                    <div class="flex flex-col">
                        <label class="text-[9px] font-black uppercase text-slate-400 ml-1 mb-1">Origem</label>
                        <select id="filter-origin" class="w-full px-3 py-2 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-800 text-[11px] font-bold outline-none"></select>
                    </div>
                    <div class="flex flex-col">
                        <label class="text-[9px] font-black uppercase text-slate-400 ml-1 mb-1">Status</label>
                        <select id="filter-status" class="w-full px-3 py-2 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-800 text-[11px] font-bold outline-none">
                            <option value="all">Ver Tudo</option>
                            <option value="used">Ativas</option>
                            <option value="unused">Disponíveis</option>
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <label class="text-[9px] font-black uppercase text-slate-400 ml-1 mb-1">Ordem</label>
                        <select id="sort-by" class="w-full px-3 py-2 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-800 text-[11px] font-bold outline-none">
                            <option value="profit">Maior Lucro</option>
                            <option value="dist">Distância</option>
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <label class="text-[9px] font-black uppercase text-slate-400 ml-1 mb-1">Exibir</label>
                        <select id="items-per-page" class="w-full px-3 py-2 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-800 text-[11px] font-bold outline-none">
                            <option value="100">100 por pág.</option>
                            <option value="50">50 por pág.</option>
                            <option value="0">Ver Todas</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Grid de Rotas -->
            <div id="routes-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                <!-- Cards serão injetados aqui -->
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="hidden text-center py-20 bg-white dark:bg-slate-800 rounded-3xl border-2 border-dashed border-slate-200 dark:border-slate-800">
                <i data-lucide="upload" class="mx-auto text-slate-300 w-12 h-12 mb-4"></i>
                <h3 class="font-black uppercase text-slate-400">Hub Desconectado</h3>
                <p class="text-xs text-slate-500 mt-2 px-10">Carregue o seu CSV para começar a gerir as rotas.</p>
            </div>

            <!-- Paginação -->
            <div id="pagination-controls" class="hidden mt-8 flex items-center justify-center gap-4 p-4 bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-800">
                <button id="prev-page" class="p-2 bg-slate-100 dark:bg-slate-700 rounded-lg disabled:opacity-20 transition-all">
                    <i data-lucide="chevron-left"></i>
                </button>
                <span id="page-info" class="text-xs font-black">Página 1 / 1</span>
                <button id="next-page" class="p-2 bg-slate-100 dark:bg-slate-700 rounded-lg disabled:opacity-20 transition-all">
                    <i data-lucide="chevron-right"></i>
                </button>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis Globais de Ambiente
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Init Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Estado da App
        let state = {
            user: null,
            routes: [],
            inUseRoutes: {},
            filters: {
                search: "",
                aircraft: "all",
                origin: "all",
                status: "all",
                sortBy: "profit",
                itemsPerPage: 100,
                currentPage: 1
            }
        };

        // --- AUTH ---
        async function initAuth() {
            try {
                if (initialToken) {
                    await signInWithCustomToken(auth, initialToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Erro Auth:", err);
            }
        }

        onAuthStateChanged(auth, (user) => {
            state.user = user;
            if (user) {
                setupFirestoreListeners(user.uid);
            }
        });

        // --- FIRESTORE ---
        function setupFirestoreListeners(uid) {
            const routesRef = doc(db, 'artifacts', appId, 'users', uid, 'data', 'routes');
            const statusRef = doc(db, 'artifacts', appId, 'users', uid, 'data', 'status');

            onSnapshot(routesRef, (docSnap) => {
                state.routes = docSnap.exists() ? docSnap.data().list || [] : [];
                document.getElementById('loading-screen').classList.add('hidden');
                updateFiltersOptions();
                render();
            });

            onSnapshot(statusRef, (docSnap) => {
                state.inUseRoutes = docSnap.exists() ? docSnap.data().active || {} : {};
                render();
            });
        }

        async function saveRoutesToCloud(list) {
            if (!state.user) return;
            const ref = doc(db, 'artifacts', appId, 'users', state.user.uid, 'data', 'routes');
            await setDoc(ref, { list });
        }

        async function toggleRouteUse(routeId) {
            if (!state.user) return;
            const newStatus = { ...state.inUseRoutes, [routeId]: !state.inUseRoutes[routeId] };
            const ref = doc(db, 'artifacts', appId, 'users', state.user.uid, 'data', 'status');
            await setDoc(ref, { active: newStatus });
        }

        // --- LOGICA UI ---
        const formatTime = (hours) => {
            if (isNaN(hours)) return "0h 0m";
            const h = Math.floor(hours);
            const m = Math.round((hours - h) * 60);
            return `${h}h ${m}m`;
        };

        function render() {
            const grid = document.getElementById('routes-grid');
            const empty = document.getElementById('empty-state');
            
            // Filtragem
            let filtered = state.routes.filter(r => {
                const matchesSearch = r.name.toLowerCase().includes(state.filters.search.toLowerCase()) || 
                                    r.iata.toLowerCase().includes(state.filters.search.toLowerCase());
                const isUsed = !!state.inUseRoutes[r.id];
                const matchesStatus = state.filters.status === 'all' || 
                                     (state.filters.status === 'used' ? isUsed : !isUsed);
                const matchesAircraft = state.filters.aircraft === 'all' || r.aircraft === state.filters.aircraft;
                const matchesOrigin = state.filters.origin === 'all' || r.origin === state.filters.origin;
                
                return matchesSearch && matchesStatus && matchesAircraft && matchesOrigin;
            });

            // Ordenação
            filtered.sort((a, b) => {
                return state.filters.sortBy === 'profit' ? b.profit - a.profit : b.dist - a.dist;
            });

            // Estatísticas
            document.getElementById('stat-total').innerText = state.routes.length;
            document.getElementById('stat-active').innerText = Object.values(state.inUseRoutes).filter(v => v).length;
            const totalProfit = filtered.reduce((acc, curr) => acc + curr.profit, 0);
            document.getElementById('stat-profit').innerText = `$${totalProfit.toLocaleString('pt-PT', { maximumFractionDigits: 0 })}`;

            // Paginação
            const totalItems = filtered.length;
            const itemsPerPage = state.filters.itemsPerPage === 0 ? totalItems : state.filters.itemsPerPage;
            const totalPages = itemsPerPage === 0 ? 1 : Math.ceil(totalItems / itemsPerPage);
            
            if (state.filters.currentPage > totalPages && totalPages > 0) state.filters.currentPage = totalPages;
            
            const start = (state.filters.currentPage - 1) * itemsPerPage;
            const paginated = filtered.slice(start, start + itemsPerPage);

            // Render Cards
            grid.innerHTML = '';
            if (state.routes.length === 0) {
                empty.classList.remove('hidden');
                document.getElementById('pagination-controls').classList.add('hidden');
            } else {
                empty.classList.add('hidden');
                paginated.forEach(r => {
                    const card = createRouteCard(r, !!state.inUseRoutes[r.id]);
                    grid.appendChild(card);
                });
                
                // Update Paginação UI
                const pagContainer = document.getElementById('pagination-controls');
                if (state.filters.itemsPerPage > 0 && totalPages > 1) {
                    pagContainer.classList.remove('hidden');
                    document.getElementById('page-info').innerText = `Página ${state.filters.currentPage} / ${totalPages}`;
                    document.getElementById('prev-page').disabled = state.filters.currentPage === 1;
                    document.getElementById('next-page').disabled = state.filters.currentPage === totalPages;
                } else {
                    pagContainer.classList.add('hidden');
                }
            }

            lucide.createIcons();
        }

        function createRouteCard(data, isInUse) {
            const div = document.createElement('div');
            div.className = `relative transition-all duration-300 rounded-2xl border overflow-hidden hover:shadow-xl ${
                isInUse ? 'bg-emerald-50/40 border-emerald-500 ring-2 sm:ring-4 ring-emerald-500/10' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 shadow-md'
            }`;

            const stopoverHtml = data.stopover ? `
                <div class="p-3 rounded-xl border flex items-center gap-3 ${isInUse ? 'bg-emerald-700/40 border-emerald-400/20 text-emerald-50' : 'bg-amber-50 dark:bg-amber-900/10 border-amber-100 dark:border-amber-900/30'}">
                    <div class="p-2 rounded-lg ${isInUse ? 'bg-emerald-800/50 text-emerald-300' : 'bg-amber-100 dark:bg-amber-900/50 text-amber-600'}">
                        <i data-lucide="navigation" class="w-4 h-4"></i>
                    </div>
                    <div class="text-xs min-w-0 flex-1">
                        <p class="font-black uppercase text-[9px] tracking-widest ${isInUse ? 'text-emerald-200' : 'text-amber-700 dark:text-amber-400'}">Escala Obrigatória</p>
                        <p class="font-bold truncate leading-tight">${data.stopover.name} (${data.stopover.iata})</p>
                        <p class="text-[10px] mt-0.5 font-medium ${isInUse ? 'text-emerald-100' : 'text-slate-500'}">${data.stopover.country}</p>
                    </div>
                </div>
            ` : '';

            div.innerHTML = `
                ${isInUse ? `<div class="absolute top-0 right-0 z-10"><div class="bg-emerald-600 text-white text-[9px] sm:text-[10px] font-black px-3 sm:px-4 py-1.5 rounded-bl-2xl flex items-center gap-1 sm:gap-2 shadow-lg uppercase tracking-widest"><i data-lucide="check-circle-2" class="w-3 h-3"></i>Em Operação</div></div>` : ''}
                <div class="p-4 sm:p-5 border-b ${isInUse ? 'bg-emerald-500/10 border-emerald-100' : 'bg-slate-50 dark:bg-slate-900/50 border-slate-200 dark:border-slate-700'}">
                    <div class="flex flex-col gap-3">
                        <div class="flex items-center flex-wrap gap-y-2 gap-x-1.5">
                            <span class="bg-blue-600 text-white text-[9px] font-black px-2 py-0.5 rounded shadow-sm">${data.origin || 'JFK'}</span>
                            <i data-lucide="arrow-right" class="text-slate-400 w-3 h-3"></i>
                            ${data.stopover ? `<span class="bg-amber-500 text-white text-[9px] font-black px-2 py-0.5 rounded shadow-sm">${data.stopover.iata}</span><i data-lucide="arrow-right" class="text-slate-400 w-3 h-3"></i>` : ''}
                            <span class="bg-emerald-600 text-white text-[9px] font-black px-2 py-0.5 rounded shadow-sm">${data.iata}</span>
                        </div>
                        <div class="flex justify-between items-start gap-2">
                            <div class="flex-1 min-w-0">
                                <h3 class="font-black text-slate-800 dark:text-slate-100 text-lg leading-tight truncate">${data.name}</h3>
                                <p class="text-slate-500 text-xs flex items-center gap-1 mt-1 font-bold"><i data-lucide="map-pin" class="text-blue-500 w-3 h-3"></i> ${data.country}</p>
                            </div>
                            ${!isInUse ? `<div class="text-right shrink-0"><div class="text-emerald-600 font-black text-lg flex items-center justify-end leading-none"><span class="text-xs font-bold mr-0.5">$</span>${data.profit.toLocaleString('pt-PT', { maximumFractionDigits: 0 })}</div><p class="text-[8px] uppercase tracking-widest text-slate-400 font-black mt-1">Lucro / Voo</p></div>` : ''}
                        </div>
                        <div class="flex"><span class="bg-slate-200 dark:bg-slate-700 text-[8px] px-2 py-0.5 rounded font-black text-slate-600 dark:text-slate-300 uppercase">${data.aircraft}</span></div>
                    </div>
                </div>
                <div class="p-4 sm:p-5 space-y-4">
                    <div class="grid grid-cols-3 gap-2">
                        <div class="bg-slate-50 dark:bg-slate-900/50 p-2 rounded-xl text-center border border-slate-100 dark:border-slate-700">
                            <p class="text-[8px] text-slate-400 uppercase font-black mb-0.5">Distância</p>
                            <p class="text-xs font-black">${Math.round(data.dist)} km</p>
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-900/50 p-2 rounded-xl text-center border border-slate-100 dark:border-slate-700">
                            <p class="text-[8px] text-slate-400 uppercase font-black mb-0.5">Duração</p>
                            <p class="text-xs font-black">${formatTime(data.time)}</p>
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-900/50 p-2 rounded-xl text-center border border-slate-100 dark:border-slate-700">
                            <p class="text-[8px] text-slate-400 uppercase font-black mb-0.5">Mercado</p>
                            <p class="text-xs font-black">${data.market}%</p>
                        </div>
                    </div>
                    ${stopoverHtml}
                    <div class="p-3 rounded-xl border-2 ${isInUse ? 'bg-emerald-600 text-white border-emerald-400' : 'bg-blue-50/30 dark:bg-blue-900/10 border-blue-100 dark:border-blue-900/20'}">
                        <div class="flex justify-between items-center mb-2">
                             <span class="text-[9px] font-black uppercase tracking-wider">Lugares e Preços</span>
                             <i data-lucide="plane" class="w-3.5 h-3.5"></i>
                        </div>
                        <div class="grid grid-cols-1 gap-2">
                            <div class="flex justify-between items-center pb-1 border-b border-dashed border-current opacity-80">
                                <span class="text-[10px] font-bold">Económica (Y)</span>
                                <div class="flex items-center gap-2">
                                    <span class="text-[11px] font-black">${data.config.y}</span>
                                    <div class="px-1.5 py-0.5 rounded bg-black/20 font-black text-[10px]">$${data.prices.y}</div>
                                </div>
                            </div>
                            <div class="flex justify-between items-center pb-1 border-b border-dashed border-current opacity-80">
                                <span class="text-[10px] font-bold">Executiva (J)</span>
                                <div class="flex items-center gap-2">
                                    <span class="text-[11px] font-black">${data.config.j}</span>
                                    <div class="px-1.5 py-0.5 rounded bg-black/20 font-black text-[10px]">$${data.prices.j}</div>
                                </div>
                            </div>
                            <div class="flex justify-between items-center pb-1 border-b border-dashed border-current opacity-80 last:border-0">
                                <span class="text-[10px] font-bold">Primeira (F)</span>
                                <div class="flex items-center gap-2">
                                    <span class="text-[11px] font-black">${data.config.f}</span>
                                    <div class="px-1.5 py-0.5 rounded bg-black/20 font-black text-[10px]">$${data.prices.f}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="use-btn w-full py-3 rounded-xl text-[10px] font-black uppercase tracking-[0.1em] transition-all flex items-center justify-center gap-2 shadow-sm ${isInUse ? 'bg-slate-900 text-white' : 'bg-white text-emerald-600 border-2 border-emerald-600'}">
                        ${isInUse ? '<i data-lucide="check-circle-2" class="w-4 h-4"></i> LIBERAR ROTA' : 'UTILIZAR ROTA'}
                    </button>
                </div>
            `;

            div.querySelector('.use-btn').onclick = () => toggleRouteUse(data.id);
            return div;
        }

        function updateFiltersOptions() {
            const airSel = document.getElementById('filter-aircraft');
            const oriSel = document.getElementById('filter-origin');
            
            const aircrafts = Array.from(new Set(state.routes.map(r => r.aircraft)));
            const origins = Array.from(new Set(state.routes.map(r => r.origin)));

            airSel.innerHTML = '<option value="all">Todas as Aeronaves</option>' + 
                aircrafts.map(a => `<option value="${a}">${a}</option>`).join('');
            oriSel.innerHTML = '<option value="all">Todas as Origens</option>' + 
                origins.map(o => `<option value="${o}">${o}</option>`).join('');
        }

        // --- HANDLERS ---
        document.getElementById('search-input').addEventListener('input', (e) => {
            state.filters.search = e.target.value;
            state.filters.currentPage = 1;
            render();
        });

        document.getElementById('filter-aircraft').addEventListener('change', (e) => {
            state.filters.aircraft = e.target.value;
            state.filters.currentPage = 1;
            render();
        });

        document.getElementById('filter-origin').addEventListener('change', (e) => {
            state.filters.origin = e.target.value;
            state.filters.currentPage = 1;
            render();
        });

        document.getElementById('filter-status').addEventListener('change', (e) => {
            state.filters.status = e.target.value;
            state.filters.currentPage = 1;
            render();
        });

        document.getElementById('sort-by').addEventListener('change', (e) => {
            state.filters.sortBy = e.target.value;
            render();
        });

        document.getElementById('items-per-page').addEventListener('change', (e) => {
            state.filters.itemsPerPage = parseInt(e.target.value);
            state.filters.currentPage = 1;
            render();
        });

        document.getElementById('prev-page').onclick = () => {
            if (state.filters.currentPage > 1) {
                state.filters.currentPage--;
                window.scrollTo(0, 0);
                render();
            }
        };

        document.getElementById('next-page').onclick = () => {
            state.filters.currentPage++;
            window.scrollTo(0, 0);
            render();
        };

        document.getElementById('csv-upload').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const fileName = file.name.toLowerCase();
            const reader = new FileReader();
            reader.onload = (e) => {
                const lines = e.target.result.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                const newRoutes = lines.slice(1).filter(l => l.trim()).map((line, idx) => {
                    const values = line.split(',');
                    const obj = {};
                    headers.forEach((h, i) => { obj[h] = values[i]; });
                    return {
                        id: obj['dest.id'] || `${idx}-${Date.now()}`,
                        name: obj['dest.name'] || 'Destino',
                        country: obj['dest.country'] || 'País',
                        iata: obj['dest.iata'] || '???',
                        dist: parseFloat(obj['direct_dist']) || 0,
                        time: parseFloat(obj['time']) || 0,
                        config: { y: obj['cfg.y'] || 0, j: obj['cfg.j'] || 0, f: obj['cfg.f'] || 0 },
                        prices: { y: obj['tkt.y'] || 0, j: obj['tkt.j'] || 0, f: obj['tkt.f'] || 0 },
                        profit: parseFloat(obj['profit_pt']) || 0,
                        stopover: obj['stop.iata'] ? { 
                            iata: obj['stop.iata'], 
                            name: obj['stop.name'],
                            country: obj['stop.country'] || 'Desconhecido'
                        } : null,
                        market: Math.round(parseFloat(obj['market']) * 100) / 100 || 45,
                        aircraft: fileName.includes("mc214") ? "MC-21-400" : (fileName.includes("a320") ? "A320" : "Aeronave"),
                        origin: fileName.includes("jfk") ? "JFK" : "Origem"
                    };
                });
                saveRoutesToCloud(newRoutes);
            };
            reader.readAsText(file);
        });

        window.toggleMobileMenu = () => {
            const filters = document.getElementById('filter-container');
            const icon = document.getElementById('menu-icon');
            if (filters.classList.contains('hidden')) {
                filters.classList.remove('hidden');
                icon.setAttribute('data-lucide', 'x');
            } else {
                filters.classList.add('hidden');
                icon.setAttribute('data-lucide', 'menu');
            }
            lucide.createIcons();
        };

        // Init
        initAuth();
    </script>
</body>
</html>
